<head>
    <title>Limitless Image Upload</title>
  </head>
  <body>
    <h1>Welcome!</h1>
    <br>Please select an image
    <input type="file" id="image">
    <br>
    <img id="preview">

    <script>

      // var xmlhttp = new XMLHttpRequest();   // new HttpRequest instance 
      // xmlhttp.open("POST", "https://b5hrtlne7l.execute-api.us-east-1.amazonaws.com/dev/analysis",true);
      // xmlhttp.setRequestHeader("Content-Type", "application/json");
      // xmlhttp.send(JSON.stringify({ "bucket": "rjs-rekog-test-bucket-2", "imageName": "bikini.jpg" }));

      // var xhttp = new XMLHttpRequest();
      //   xhttp.onreadystatechange = function() {
      //     if (this.readyState == 4 && this.status == 200) {
      //       document.getElementById("demo").innerHTML = this.responseText;
      //     }
      //   };
      //   xhttp.open("POST", "https://b5hrtlne7l.execute-api.us-east-1.amazonaws.com/dev/analysis", true);
      //   xhttp.send({
      //     "bucket": "rjs-rekog-test-bucket-2",
      //     "imageName": "bikini.jpg"
      //   });


      //       var xhr = new XMLHttpRequest()
          
      //     xhr.open("POST", "https://b5hrtlne7l.execute-api.us-east-1.amazonaws.com/dev/analysis", true)
      //     xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      //     xhr.setRequestHeader("Content-length", params.length); xhr.setRequestHeader("Connection", "close");

      //     // + file.name + "&file_type=" + file.type)

      //     xhr.onreadystatechange = function() {
      //       if(xhr.readyState === 4 && xhr.status === 200) {
      //       var response = JSON.parse(xhr.responseText)
      //       done(response)
      //   }
      //   xhr.send({
      //     "bucket": "rjs-rekog-test-bucket-2",
      //     "imageName": "bikini.jpg"
      // }) 

    function upload(file, signed_request, url, done) {
      var xhr = new XMLHttpRequest()
      xhr.open("PUT", signed_request)
      xhr.setRequestHeader('x-amz-acl', 'public-read')
      xhr.onload = function() {
        if (xhr.status === 200) {
          done()
        }
      }

      xhr.send(file)
    }

    function sign_request(file, done) {
      var xhr = new XMLHttpRequest()
      xhr.open("GET", "/sign?file_name=" + file.name + "&file_type=" + file.type)

      xhr.onreadystatechange = function() {
        if(xhr.readyState === 4 && xhr.status === 200) {
          var response = JSON.parse(xhr.responseText)
          done(response)
        }
      }

      xhr.send()
    }

    document.getElementById("image").onchange = function() {
      var file = document.getElementById("image").files[0]
      if (!file) return

      sign_request(file, function(response) {
        upload(file, response.signed_request, response.url, function() {
          document.getElementById("preview").src = response.url
          var xhr = new XMLHttpRequest()
          
          xhr.open("GET", "/api/rekog?file_name=" + file.name)
          // + file.name + "&file_type=" + file.type)

          xhr.onreadystatechange = function() {
            if(xhr.readyState === 4 && xhr.status === 200) {
            var response = JSON.parse(xhr.responseText)
            // done(response)
            //RESPONSE IS MY OBJECT 
            console.log(response);
            }
          
          }
          xhr.send() 

       
        })
      })
    }
    </script>
  </body>